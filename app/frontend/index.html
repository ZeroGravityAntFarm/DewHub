<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
    <title>Dewrito Share</title>

    <!-- <link href="index.css" rel="stylesheet"> -->
  </head>
  <body>
    <div class="bg"></div>
    
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">Dewrito Share</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarScroll" aria-controls="navbarScroll" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <form class="d-flex">
            <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-success" type="submit">Search</button>
          </form>
          <div class="collapse navbar-collapse" id="navbarScroll">
            <ul class="navbar-nav me-auto my-2 my-lg-0 navbar-nav-scroll" style="--bs-scroll-height: 100px;">
            </ul>
            <form class="d-flex">
              <div id="user-prof"></div>
            </form>
          </div>
        </div>
      </nav>

      <div class="modal" tabindex="-1" id="map-upload">
  	<div class="modal-dialog modal-lg">
    	  <div class="modal-content">
      	    <div class="modal-header">
              <h5 class="modal-title">Map Upload</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      	    </div>
      	    <div class="modal-body">
              <div class="mb-3">
                <label for="formFile" class="form-label">Map File</label>
                <input class="form-control" type="file" id="mapFile">
              </div>
	      <div class="mb-3">
                <label for="formFile" class="form-label">Variant File</label>
                <input class="form-control" type="file" id="variantFile">
              </div>
	      <div class="mb-3">
                <label for="formFileMultiple" class="form-label">Map Images</label>
                <input class="form-control" type="file" id="formFileMultiple" multiple>
              </div>
	      <div>
	        <h5>Tag</h5>
                <select class="form-select" aria-label="map tags">
                  <option selected>Slayer</option>
                  <option value="1">Infection</option>
                  <option value="2">Puzzel</option>
                  <option value="3">CTF</option>
		  <option value="4">Assault</option>
		  <option value="5">Territories</option>
		  <option value="6">Infection</option>
		  <option value="7">Juggernaut</option>
		  <option value="8">VIP</option>
                </select>
	      </div>
      	    </div>
      	    <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary">Upload</button>
      	    </div>
    	  </div>
  	</div>
      </div>

      <div id="map-container" class="container">
        <div class="row">
          <div id="map-cards"></div>
        </div>
      </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.16/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
  </body>
</html>

<script>

token = getCookie("Authorization")
function userLogin() {
  var trHTML = ''
  if (token) {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open( "GET", "https:////api.zgaf.io/api_v1/me", false );
      bearer_token = "Bearer " + token
      xmlHttp.setRequestHeader("Authorization", bearer_token);
      xmlHttp.send();
      const user = JSON.parse(xmlHttp.responseText);

      if (xmlHttp.status == 200){
	  trHTML += '<button type="button" data-bs-toggle="modal" data-bs-target="#map-upload" class="btn btn-outline-info me-1"><i class="bi bi-plus-square"></i></button>'
          trHTML += '<a href="https://fileshare.zgaf.io/profile/index.html" class="btn btn-outline-primary me-1">'+user["name"]+'</a>'
          trHTML += '<a href="https://fileshare.zgaf.io/index.html" onclick="logout();" class="btn btn-outline-danger me-1">Logout</a>'

      } else {
          trHTML += '<a href="https://fileshare.zgaf.io/login/index.html" class="btn btn-outline-primary me-1">Login</a>'
          trHTML += '<a href="https://fileshare.zgaf.io/register/index.html" class="btn btn-outline-primary me-1">Register</a>'
      }
      document.getElementById("user-prof").innerHTML = trHTML;
  } else {

    trHTML += '<a href="https://fileshare.zgaf.io/login/index.html" class="btn btn-outline-primary me-1">Login</a>'
    trHTML += '<a href="https://fileshare.zgaf.io/register/index.html" class="btn btn-outline-primary me-1">Register</a>'
    document.getElementById("user-prof").innerHTML = trHTML;
  }
}

function logout() {
    setCookie("Authorization", "", 1)
    window.location.href = "https://fileshare.zgaf.io/index.html";
}

function loadCards() {
  const xhttp = new XMLHttpRequest();
  xhttp.open("GET", "//api.zgaf.io/api_v1/maps/");
  xhttp.send();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var trHTML = ''; 
      const objects = JSON.parse(this.responseText);
      for (let [i, object] of objects.entries()) {

        if (i % 3 === 0){
            trHTML += '</div>';
            trHTML += '<div class="row top-buffer">';
          }

        trHTML += '<div class="col mb-3 mt-4">';
        trHTML += '<div class="card text-white bg-dark" >';
        trHTML += '<img src="https://api.zgaf.io/static/maps/'+object['id']+'/0" class="card-img-top" alt="..." onerror="this.onerror=null;this.src=\'https://api.zgaf.io/static/content/default/forge.jpg\';">';
        trHTML += '<div class="card-body">';
        trHTML += '<h4 class="card-title">'+object['mapName']+'</h4>';
        trHTML += '<h5 class="card-title">Author: '+object['mapAuthor']+'</h5>';
        trHTML += '</div>';
        trHTML += '<p class="card-text p-3">'+object['mapDescription']+'</p>';
        trHTML += '</ul>';
        trHTML += '<div class="d-grid gap-2 d-md-block p-3">';
        trHTML += '<a href="https://api.zgaf.io/api_v1/maps/'+object['mapName']+'/file/" class="btn btn-primary me-1">Map File</a>';
        trHTML += '<a href="https://api.zgaf.io/api_v1/maps/'+object['mapName']+'/variant/file/" class="btn btn-primary me-1">Variant File</a>';
        trHTML += '</div>'
        trHTML += '<div class="card-footer"><small class="text-muted">Downloads: '+object['map_downloads']+'</small></div>';
        trHTML += '</div>';
        trHTML += '</div>';

      }
    }
    document.getElementById("map-cards").innerHTML = trHTML;
  }
}

function setCookie(c_name, value, exdays) {
    var exdate = new Date();
    exdate.setDate(exdate.getDate() + exdays);
    var c_value = escape(value) + ((exdays == null) ? "" : "; expires=" + exdate.toUTCString());
    document.cookie = c_name + "=" + c_value + "; SameSite=None; " + "Secure;" + "path=/";
    console.log(document.cookie)
}

function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

userLogin();
loadCards();
</script>

<style>  
    body {
        font-size: 1.25rem;
        background-image: url("https://fileshare.zgaf.io/content/halo.jpg");
        background-position: center;
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
    }

    map-container{
        margin-top: 25%;
    }

    td {
        line-height: 3rem;
    }

    .avatar {
        vertical-align: middle;
        width: 100px;
        height: 100px;
        border-radius: 50%;
    }
</style>
